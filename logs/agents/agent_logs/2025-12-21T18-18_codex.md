# Agent Log — TE Cache (Stop Recomputing TE Across Sweeps)

- Agent: Codex CLI
- Model: GPT-5.2
- Created (UTC): 2025-12-21T18:18:49+00:00

## Why

Repeatedly recomputing TE across the 40-run full grid creates large pandas intermediates (groupby + MultiIndex alignment) and contributes to peak RAM spikes. TE is split-independent (online-safe by hour) so it can be precomputed once for a given sample parquet + TE config and reused across all specs/folds.

## What changed

- Added `kaggle_clicks/precompute_te.py`:
  - Precomputes TE + `prior_ctr` once and writes a compact parquet keyed by `row_id` (and `hour_dt` for sanity checks).
- Updated `kaggle_clicks/run_baseline_te.py`:
  - New flag `--te-parquet` to reuse cached TE and skip TE recomputation.
  - Time-agg now runs on a minimal frame (`hour_dt`, `click`, entities) to avoid copying TE columns during time-agg construction.
- Updated sweep runners to pass through `--te-parquet`:
  - `kaggle_clicks/run_sweep_family_a.py`
  - `kaggle_clicks/run_sweep_family_a_full_grid.py`
- Updated docs:
  - `docs/AGENT_ONBOARDING.md` (added “Precompute TE once” workflow and `--te-parquet` notes).

## Smoke checks

- Precompute on 0.1% sample:
  - `python -m kaggle_clicks.precompute_te --sample-parquet data/interim/train_sample_0p1pct.parquet --out-parquet data/interim/te_cache/train_sample_0p1pct_te_m100.parquet --m 100 --overwrite`
- Baseline using cache:
  - `python -m kaggle_clicks.run_baseline_te --sample-parquet data/interim/train_sample_0p1pct.parquet --run-tag tecache_smoke --n-estimators 30 --max-depth 4 --n-jobs 2 --te-parquet data/interim/te_cache/train_sample_0p1pct_te_m100.parquet`
- Full-grid sweep smoke using cache:
  - `runs/sweeps/20251221_181746_tecache_sweep_smoke_s1pct/`

## Next step (for 10% full grid)

1. Precompute TE once:
   - `python -m kaggle_clicks.precompute_te --sample-parquet data/interim/train_sample_10pct.parquet --out-parquet data/interim/te_cache/train_sample_10pct_te_m100.parquet --m 100`
2. Run the sweep with TE reuse:
   - add `--te-parquet data/interim/te_cache/train_sample_10pct_te_m100.parquet`

